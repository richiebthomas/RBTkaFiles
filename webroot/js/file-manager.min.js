class FileManager{constructor(){this.currentPath=window.currentPath||"",this.selectedItem=null,this.notesVisible=!1,this.currentNotes="",this.hoverTimeout=null,this.hoverHideTimeout=null,this.isProcessingMove=!1,this.searchTimeout=null,this.searchVisible=!1,this.init()}encodePath(e){return e?e.split("/").map((e=>encodeURIComponent(e))).join("/"):""}init(){this.bindEvents(),this.loadDirectory(this.currentPath)}bindEvents(){$("#btn-create-folder").on("click",(()=>this.showCreateFolderModal())),$("#btn-upload").on("click",(()=>$("#file-input").click())),$("#file-input").on("change",(e=>this.handleFileUpload(e))),$("#btn-create-folder-confirm").on("click",(()=>this.createFolder())),$("#btn-rename-confirm").on("click",(()=>this.renameItem())),$(document).on("contextmenu",".file-item",(e=>this.showContextMenu(e))),$(document).on("click",(()=>this.hideContextMenu())),$("#ctx-download").on("click",(()=>this.downloadItem())),$("#ctx-print").on("click",(()=>this.showPrintModal())),$("#ctx-rename").on("click",(()=>this.showRenameModal())),$("#ctx-delete").on("click",(()=>this.deleteItem())),$("#print-form").on("submit",(e=>this.handlePrintSubmit(e))),$(document).on("input","#print-roll",(e=>this.handleRollNumberInput(e))),$(document).on("mouseenter",".file-item",(e=>this.handleItemHover(e))),$(document).on("mouseleave",".file-item",(e=>this.handleItemHoverLeave(e))),$(document).on("click",".file-item",(e=>this.handleItemClick(e))),$(document).on("dblclick",".file-item",(e=>this.handleItemDoubleClick(e))),$(document).on("click",".close-preview",(()=>this.closePreview())),$(document).on("mouseenter","#preview-panel",(()=>this.handlePreviewPanelEnter())),$(document).on("mouseleave","#preview-panel",(()=>this.handlePreviewPanelLeave())),$(document).on("dragstart",".file-item",(e=>this.handleDragStart(e))),$(document).on("dragenter",".drop-target",(e=>this.handleDragEnter(e))),$(document).on("dragover",".drop-target",(e=>this.handleDragOver(e))),$(document).on("dragleave",".drop-target",(e=>this.handleDragLeave(e))),$(document).on("drop",".drop-target",(e=>this.handleDrop(e))),$(document).on("dragend",".file-item",(e=>this.handleDragEnd(e))),$(document).on("click",".breadcrumb-item a",(e=>this.navigateToPath(e))),this.setupFileDragAndDrop(),$(document).on("keydown",(e=>this.handleKeyboard(e))),$("#folder-name").on("keypress",(e=>{13===e.which&&$("#btn-create-folder-confirm").click()})),$("#rename-input").on("keypress",(e=>{13===e.which&&$("#btn-rename-confirm").click()})),$(document).on("click",".read-more-btn",(e=>this.toggleReadMore(e))),$(document).on("click","#add-note",(()=>{const e=$("#notes-list"),t=this.createNoteElement({id:"new",content:"",created:(new Date).toISOString()});e.prepend(t),this.enterNoteEditMode(t)})),$(document).on("click",".edit-note",(e=>{const t=$(e.currentTarget).closest(".note-item");this.enterNoteEditMode(t)})),$(document).on("click",".delete-note",(e=>{const t=$(e.currentTarget).closest(".note-item").data("note-id");this.deleteNote(t)})),$(document).on("click",".save-note",(e=>{const t=$(e.currentTarget).closest(".note-item");this.exitNoteEditMode(t,!0)})),$(document).on("click",".cancel-edit",(e=>{const t=$(e.currentTarget).closest(".note-item");this.exitNoteEditMode(t,!1)})),$(document).on("keydown",".note-editor",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=$(e.currentTarget).closest(".note-item");this.exitNoteEditMode(t,!0)}})),$(document).on("input","#search-input",(e=>this.handleSearchInput(e))),$(document).on("focus","#search-input",(()=>this.showSearchSuggestions())),$(document).on("blur","#search-input",(e=>this.handleSearchBlur(e))),$(document).on("keydown","#search-input",(e=>this.handleSearchKeydown(e))),$(document).on("click",".search-suggestion",(e=>this.handleSuggestionClick(e))),$(document).on("click","#search-clear",(()=>this.clearSearch()))}setupFileDragAndDrop(){$("#file-listing").on("dragenter dragover",(e=>{e.originalEvent.dataTransfer.types.includes("Files")&&(e.preventDefault(),$(e.currentTarget).addClass("drag-over"))})),$("#file-listing").on("dragleave",(e=>{$(e.currentTarget).is(e.relatedTarget)||$(e.currentTarget).has(e.relatedTarget).length||$(e.currentTarget).removeClass("drag-over")})),$("#file-listing").on("drop",(e=>{$(e.currentTarget).removeClass("drag-over");const t=e.originalEvent.dataTransfer.files;t&&t.length>0&&(e.preventDefault(),this.uploadFiles(t))}))}handleDragStart(e){const t=$(e.currentTarget);this.draggedItem={path:t.data("path"),type:t.data("type"),name:t.data("name")},e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(this.draggedItem)),e.originalEvent.dataTransfer.effectAllowed="move",t.addClass("dragging"),this.closePreview()}handleDragEnter(e){e.preventDefault();const t=$(e.currentTarget);this.isValidDropTarget(t)&&t.addClass("drag-over-target")}handleDragOver(e){e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move"}handleDragLeave(e){const t=$(e.currentTarget);t.is(e.relatedTarget)||t.has(e.relatedTarget).length||t.removeClass("drag-over-target")}handleDrop(e){e.preventDefault();const t=$(e.currentTarget);if(t.removeClass("drag-over-target"),!this.draggedItem)return;if(this.isProcessingMove)return;let s="";t.hasClass("breadcrumb-item")?s=t.find("a").data("path")||"":t.is("a")&&t.parent().hasClass("breadcrumb-item")?s=t.data("path")||"":t.hasClass("file-item")&&(s=t.data("path")),s!==this.draggedItem.path&&this.dirname(this.draggedItem.path)!==s&&this.moveItem(this.draggedItem.path,s)}handleDragEnd(e){$(e.currentTarget).removeClass("dragging"),$(".drag-over-target").removeClass("drag-over-target"),this.draggedItem=null,this.isProcessingMove=!1}isValidDropTarget(e){if(!this.draggedItem)return!1;if(e.hasClass("breadcrumb-item")||e.is("a")&&e.parent().hasClass("breadcrumb-item"))return!0;if(e.hasClass("file-item")&&"folder"===e.data("type")){const t=e.data("path");return"folder"!==this.draggedItem.type||t!==this.draggedItem.path&&!t.startsWith(this.draggedItem.path+"/")}return!1}moveItem(e,t){this.isProcessingMove||(this.isProcessingMove=!0,$.ajax({url:"/api/move",method:"POST",data:{source_path:e,target_path:t},dataType:"json",success:e=>{this.isProcessingMove=!1,e.success?(this.showSuccess("Item moved successfully"),this.loadDirectory(this.currentPath)):this.showError(e.message||"Failed to move item")},error:e=>{this.isProcessingMove=!1,this.showError("Failed to move item: "+e.statusText)}}))}dirname(e){if(!e)return"";const t=e.split("/");return t.pop(),t.join("/")}loadDirectory(e){this.showLoading(),this.currentPath=e;const t=e?`/${this.encodePath(e)}`:"/";window.history.pushState({path:e},"",t);const s="/api/browse"+(e?"/"+this.encodePath(e):"");$.ajax({url:s,method:"GET",dataType:"json",success:e=>{e.success?this.renderDirectory(e):this.showError("Failed to load directory: "+(e.message||"Unknown error"))},error:(e,t,s)=>{this.showError("Failed to load directory: "+e.statusText),this.hideLoading()}})}renderDirectory(e){this.hideLoading(),this.updateBreadcrumbs(e.breadcrumbs);const t=$("#file-grid"),s=$("#file-table-body");t.hide(),s.empty(),0===e.items.length?$("#empty-folder").show():($("#empty-folder").hide(),e.items.forEach((e=>{s.append(this.createFileItemElement(e))}))),this.currentNotes=e.notes||[],void 0!==e.notes?this.showNotes(this.currentNotes):this.hideNotes(),this.setupFileDragAndDrop()}createFileItemElement(e){const t="folder"===e.type,s=t?"fas fa-folder":this.getFileIcon(e.name,e.mime_type),i=t?"-":this.formatSize(e.size||0),a=(t||this.getFileType(e.name),$(`\n            <tr class="file-item ${e.type}" \n                data-path="${e.path}" \n                data-type="${e.type}"\n                data-name="${e.name}"\n                draggable="true">\n                <td class="file-name-cell">\n                    <div class="d-flex align-items-center">\n                        <i class="file-icon ${s}"></i>\n                        <span class="file-name" title="${e.name}">${e.name}</span>\n                    </div>\n                </td>\n                \n                <td class="file-size-cell text-end">${i}</td>\n            </tr>\n        `));return t&&a.addClass("drop-target"),a}getFileIcon(e,t){const s=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","bmp","svg","webp"].includes(s)?"fas fa-file-image":["mp4","avi","mkv","mov","wmv","flv","webm"].includes(s)?"fas fa-file-video":["mp3","wav","flac","aac","ogg","wma"].includes(s)?"fas fa-file-audio":["pdf"].includes(s)?"fas fa-file-pdf":["doc","docx"].includes(s)?"fas fa-file-word":["xls","xlsx"].includes(s)?"fas fa-file-excel":["ppt","pptx"].includes(s)?"fas fa-file-powerpoint":["zip","rar","7z","tar","gz"].includes(s)?"fas fa-file-archive":["js","html","css","php","py","java","cpp","c","cs","rb","go"].includes(s)?"fas fa-file-code":["txt","md","json","xml","yml","yaml"].includes(s)?"fas fa-file-alt":"fas fa-file"}formatSize(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["B","KB","MB","GB","TB"][t]}updateBreadcrumbs(e){const t=$("#breadcrumb");t.empty(),e.forEach(((s,i)=>{const a=i===e.length-1,o=$(`\n                <li class="breadcrumb-item drop-target ${a?"active":""}" data-path="${s.path}">\n                    ${a?s.name:`<a data-path="${s.path}">${s.name}</a>`}\n                </li>\n            `);t.append(o)}))}handleItemHover(e){const t=$(e.currentTarget),s=t.data("path"),i=t.data("type");this.draggedItem||"file"===i&&(this.hoverTimeout&&clearTimeout(this.hoverTimeout),this.hoverTimeout=setTimeout((()=>{this.showPreview(s)}),2e3))}handleItemHoverLeave(e){if(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.draggedItem)return;$(e.relatedTarget).closest("#preview-panel").length>0||(this.hoverHideTimeout&&clearTimeout(this.hoverHideTimeout),this.hoverHideTimeout=setTimeout((()=>{this.hidePreview()}),300))}handlePreviewPanelEnter(){this.hoverHideTimeout&&(clearTimeout(this.hoverHideTimeout),this.hoverHideTimeout=null)}handlePreviewPanelLeave(){this.draggedItem||(this.hoverHideTimeout&&clearTimeout(this.hoverHideTimeout),this.hoverHideTimeout=setTimeout((()=>{this.hidePreview()}),300))}handleItemClick(e){e.preventDefault();const t=$(e.currentTarget);if($(".file-item").removeClass("selected"),t.addClass("selected"),this.selectedItem={path:t.data("path"),type:t.data("type"),name:t.find(".file-name").text()},"file"===this.selectedItem.type){let e;if(this.isOfficeFile(this.selectedItem)){const t=window.location.origin+"/api/preview/"+this.encodePath(this.selectedItem.path);e="https://docs.google.com/gview?url="+encodeURIComponent(t)+"&embedded=true"}else e="/api/preview/"+this.encodePath(this.selectedItem.path);window.open(e,"_blank")}else"folder"===this.selectedItem.type?(this.loadDirectory(this.selectedItem.path),this.closePreview()):this.closePreview()}handleItemDoubleClick(e){e.preventDefault();const t=$(e.currentTarget),s=t.data("type"),i=t.data("path");if("folder"===s)this.loadDirectory(i);else{let e;const a={path:i,type:s,name:t.find(".file-name").text()};if(this.isOfficeFile(a)){const t=window.location.origin+"/api/preview/"+this.encodePath(i);e="https://docs.google.com/gview?url="+encodeURIComponent(t)+"&embedded=true"}else e="/api/preview/"+this.encodePath(i);window.open(e,"_blank")}}navigateToPath(e){e.preventDefault();const t=$(e.currentTarget).data("path");this.loadDirectory(t)}showCreateFolderModal(){$("#folder-name").val(""),$("#folder-name-error").hide(),$("#createFolderModal").modal("show"),setTimeout((()=>$("#folder-name").focus()),500)}createFolder(){const e=$("#folder-name").val().trim();e?$.ajax({url:"/api/create-folder",method:"POST",data:{parent_path:this.currentPath,name:e},dataType:"json",success:e=>{e.success?($("#createFolderModal").modal("hide"),this.showSuccess("Folder created successfully"),this.loadDirectory(this.currentPath)):this.showModalError("#folder-name-error",e.message)},error:e=>{this.showModalError("#folder-name-error","Failed to create folder: "+e.statusText)}}):this.showModalError("#folder-name-error","Folder name is required")}handleFileUpload(e){const t=e.target.files;t.length>0&&this.uploadFiles(t),$(e.target).val("")}showUploadProgress(){$("#upload-progress").show(),$(".progress-bar").css("width","0%"),$(".upload-percentage").text("0%")}updateUploadProgress(e){const t=Math.round(e);$(".progress-bar").css("width",t+"%"),$(".upload-percentage").text(t+"%")}uploadFiles(e){let t=new FormData;t.append("parent_path",this.currentPath);for(let s=0;s<e.length;s++)t.append("files[]",e[s]);this.showUploadProgress(),$.ajax({url:"/api/upload",method:"POST",data:t,processData:!1,contentType:!1,dataType:"json",xhr:()=>{const e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;this.updateUploadProgress(t)}}),!1),e},success:e=>{e.success?(this.showSuccess("Files uploaded successfully"),this.loadDirectory(this.currentPath)):this.showError(e.message||"Upload failed"),$("#upload-progress").fadeOut()},error:e=>{this.showError("Upload failed: "+e.statusText),$("#upload-progress").fadeOut()}})}showContextMenu(e){e.preventDefault();const t=$(e.currentTarget);this.selectedItem={path:t.data("path"),type:t.data("type"),name:t.find(".file-name").text()},$("#ctx-download").toggle("file"===this.selectedItem.type);const s="file"===this.selectedItem.type&&this.selectedItem.name.toLowerCase().endsWith(".pdf");$("#ctx-print").toggle(s);const i=$("#context-menu"),a=$(window).width(),o=$(window).height();let n=e.clientX,r=e.clientY;n+200>a&&(n=a-200-10),r+150>o&&(r=o-150-10),n<10&&(n=10),r<10&&(r=10),i.css({display:"block",left:n,top:r}),$(".file-item").removeClass("selected"),t.addClass("selected")}hideContextMenu(){$("#context-menu").hide()}downloadItem(){this.selectedItem&&"file"===this.selectedItem.type&&this.downloadFile(this.selectedItem.path),this.hideContextMenu()}downloadFile(e){window.location.href=`/api/download/${this.encodePath(e)}`}showRenameModal(){if(!this.selectedItem)return;const e=this.selectedItem.name;let t=e,s="";if("file"===this.selectedItem.type){const i=e.lastIndexOf(".");-1!==i&&0!==i&&(t=e.substring(0,i),s=e.substring(i))}$("#rename-input").val(t),$("#rename-error").hide(),"file"===this.selectedItem.type&&s?$("#rename-extension-info").html(`\n                <small class="text-muted">\n                    <i class="fas fa-info-circle"></i> \n                    File extension <code>${s}</code> will be preserved for security.\n                </small>\n            `).show():$("#rename-extension-info").hide(),$("#renameModal").modal("show"),setTimeout((()=>$("#rename-input").select()),500),this.hideContextMenu()}renameItem(){if(!this.selectedItem)return;let e=$("#rename-input").val().trim();if(e){if("file"===this.selectedItem.type){const t=this.selectedItem.name,s=t.lastIndexOf(".");if(-1!==s&&0!==s){const i=t.substring(s);e=e.replace(/\.[^.]*$/,""),e+=i}}e!==this.selectedItem.name?this.isValidFileName(e)?$.ajax({url:"/api/rename",method:"POST",data:{old_path:this.selectedItem.path,new_name:e},dataType:"json",success:e=>{e.success?($("#renameModal").modal("hide"),this.showSuccess("Item renamed successfully"),this.loadDirectory(this.currentPath)):this.showModalError("#rename-error",e.message)},error:e=>{this.showModalError("#rename-error","Failed to rename: "+e.statusText)}}):this.showModalError("#rename-error","Invalid filename. Avoid special characters."):$("#renameModal").modal("hide")}else this.showModalError("#rename-error","Name is required")}deleteItem(){if(!this.selectedItem)return;let e=`Are you sure you want to delete "${this.selectedItem.name}"?`;"folder"===this.selectedItem.type&&(e+="\n\nThis will delete all contents of the folder."),confirm(e)?($.ajax({url:"/api/delete",method:"POST",data:{path:this.selectedItem.path},dataType:"json",success:e=>{e.success?(this.showSuccess("Item deleted successfully"),this.loadDirectory(this.currentPath)):this.showError(e.message)},error:e=>{this.showError("Failed to delete: "+e.statusText)}}),this.hideContextMenu()):this.hideContextMenu()}handleKeyboard(e){46===e.keyCode&&this.selectedItem&&this.deleteItem(),113===e.keyCode&&this.selectedItem&&this.showRenameModal(),116===e.keyCode&&(e.preventDefault(),this.loadDirectory(this.currentPath)),27===e.keyCode&&(this.hideContextMenu(),$(".file-item").removeClass("selected"),this.selectedItem=null)}showLoading(){$("#loading").show(),$("#file-grid, #empty-folder").hide(),$("#file-table-body").empty()}hideLoading(){$("#loading").hide()}showSuccess(e){this.showNotification(e,"success")}showError(e){this.showNotification(e,"danger")}showWarning(e){this.showNotification(e,"warning")}showNotification(e,t){const s=$(`\n            <div class="alert alert-${t} alert-dismissible fade show notification" role="alert">\n                ${e}\n                <button type="button" class="close" data-dismiss="alert">\n                    <span>&times;</span>\n                </button>\n            </div>\n        `);$("body").prepend(s),setTimeout((()=>{s.alert("close")}),5e3)}showModalError(e,t){$(e).text(t).show()}showPrintModal(){this.selectedItem&&"file"===this.selectedItem.type&&($("#print-form")[0].reset(),$("#print-error").hide(),$("#user-status").hide(),$("#print-roll").val("50221"),$(".modal-title").html(`\n        <i class="fas fa-print"></i> Print: ${this.selectedItem.name}\n    `),$("#printModal").modal("show"),setTimeout((()=>$("#print-roll").focus()),500),this.hideContextMenu())}showPrintModalFromPreview(e,t){this.selectedItem={path:e,name:t,type:"file"},this.showPrintModal()}handlePrintSubmit(e){e.preventDefault();const t=new FormData;t.append("file",this.selectedItem.path),t.append("name",$("#print-name").val().trim()),t.append("roll",$("#print-roll").val().trim()),t.append("lab",$("#print-lab").val().trim());const s=$("#print-name").val().trim(),i=$("#print-roll").val().trim();if(!s||!i)return void this.showPrintError("Name and Roll Number are required.");$("#btn-print-confirm").prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> Processing...'),this.showPrintError("");const a=()=>{$.ajax({url:"/api/print",method:"POST",data:t,processData:!1,contentType:!1,xhrFields:{responseType:"blob"},success:(e,t,s)=>{if(console.log("Print response received:",{status:t,contentType:s.getResponseHeader("Content-Type"),contentLength:s.getResponseHeader("Content-Length"),dataSize:e.size,dataType:e.type}),e&&0!==e.size)try{const t=new Blob([e],{type:"application/pdf"}),s=window.URL.createObjectURL(t);window.open(s,"_blank")?($("#printModal").modal("hide"),this.showSuccess("PDF prepared for printing!"),setTimeout((()=>{window.URL.revokeObjectURL(s)}),5e3)):(this.showPrintError("Popup blocked! Please allow popups for this site and try again."),window.URL.revokeObjectURL(s))}catch(e){console.error("Error creating blob:",e),this.showPrintError("Failed to create PDF: "+e.message)}else this.showPrintError("Received empty response from server")},error:(e,t,s)=>{console.error("Print error:",{xhr:e,status:t,error:s}),console.log("Blob approach failed, trying fallback..."),o()},complete:()=>{$("#btn-print-confirm").prop("disabled",!1).html('<i class="fas fa-print"></i> Print PDF')}})},o=()=>{console.log("Trying fallback approach...");const e=document.createElement("form");e.method="POST",e.action="/api/print",e.target="_blank",e.style.display="none";const t=document.createElement("input");t.type="hidden",t.name="file",t.value=this.selectedItem.path,e.appendChild(t);const s=document.createElement("input");s.type="hidden",s.name="name",s.value=$("#print-name").val().trim(),e.appendChild(s);const i=document.createElement("input");i.type="hidden",i.name="roll",i.value=$("#print-roll").val().trim(),e.appendChild(i);const a=document.createElement("input");a.type="hidden",a.name="lab",a.value=$("#print-lab").val().trim(),e.appendChild(a),document.body.appendChild(e),e.submit(),document.body.removeChild(e),$("#printModal").modal("hide"),this.showSuccess("PDF prepared for printing!")};window.Blob&&window.URL&&window.URL.createObjectURL?(console.log("Blob support detected, trying blob approach..."),a()):(console.log("Blob not supported, using fallback approach..."),o())}showPrintError(e){$("#print-error").text(e).show()}handleRollNumberInput(e){const t=$(e.target).val().trim();$("#user-status").hide(),$("#print-error").hide(),7===t.length&&/^\d{7}$/.test(t)?this.lookupUser(t):t.length>7&&$(e.target).val(t.substring(0,7))}lookupUser(e){$.ajax({url:"/api/lookup-user",method:"POST",data:{roll_number:e},dataType:"json",success:e=>{e.success&&e.user_found?($("#print-name").val(e.user.name),$("#user-status").show().find("small").html('<i class="fas fa-check-circle"></i> User found! Name auto-filled.').removeClass("text-warning text-danger").addClass("text-success")):e.success&&!e.user_found&&($("#print-name").val("").focus(),$("#user-status").show().find("small").html('<i class="fas fa-info-circle"></i> New user - please enter your name.').removeClass("text-success text-danger").addClass("text-warning"))},error:e=>{$("#user-status").show().find("small").html('<i class="fas fa-exclamation-triangle"></i> Error looking up user.').removeClass("text-success text-warning").addClass("text-danger"),$("#print-name").focus()}})}isValidFileName(e){return!/[<>:"/\\|?*\x00-\x1f]/.test(e)&&e.length>0&&e.length<=255}isDangerousFile(e){const t=e.toLowerCase().split(".").pop();return["exe","bat","cmd","com","pif","scr","vbs","vbe","js","jse","jar","msi","msp","hta","cpl","msc","wsf","wsh","ps1","ps2","psc1","psc2","php","asp","aspx","jsp","pl","py","rb","sh","cgi","htaccess","htpasswd","ini","cfg","conf","7z","tar","gz","bz2","xz","sql","db","sqlite","mdb"].includes(t)}getSafeFileTypes(){return["pdf","doc","docx","xls","xlsx","ppt","pptx","odt","ods","odp","jpg","jpeg","png","gif","bmp","tiff","svg","webp","txt","rtf","csv","xml","json","mp3","wav","ogg","flac","aac","m4a","mp4","avi","mkv","mov","wmv","flv","webm","log","md","readme"]}getFileType(e){const t=e.toLowerCase().split(".").pop();return{pdf:"PDF Document",doc:"Word Document",docx:"Word Document",xls:"Excel Spreadsheet",xlsx:"Excel Spreadsheet",ppt:"PowerPoint",pptx:"PowerPoint",odt:"OpenDocument Text",ods:"OpenDocument Spreadsheet",odp:"OpenDocument Presentation",jpg:"JPEG Image",jpeg:"JPEG Image",png:"PNG Image",gif:"GIF Image",bmp:"Bitmap Image",svg:"SVG Image",webp:"WebP Image",tiff:"TIFF Image",txt:"Text File",rtf:"Rich Text",csv:"CSV File",xml:"XML File",json:"JSON File",log:"Log File",md:"Markdown",mp3:"MP3 Audio",wav:"WAV Audio",ogg:"OGG Audio",flac:"FLAC Audio",aac:"AAC Audio",m4a:"M4A Audio",mp4:"MP4 Video",avi:"AVI Video",mkv:"MKV Video",mov:"QuickTime Video",wmv:"WMV Video",flv:"Flash Video",webm:"WebM Video"}[t]||(t?t.toUpperCase()+" File":"File")}showPreview(e){this.draggedItem||($("#main-panel").removeClass("col-md-12").addClass("col-md-8"),$("#preview-panel").show().removeClass("hidden"),this.showPreviewLoading(),$.ajax({url:"/api/file-info",method:"GET",data:{path:e},dataType:"json",success:e=>{e.success?this.renderPreview(e.file):this.showPreviewError("Failed to load file information: "+(e.message||"Unknown error"))},error:(e,t,s)=>{let i="Failed to load file: "+e.statusText;try{const t=JSON.parse(e.responseText);t.message&&(i=t.message)}catch(e){}this.showPreviewError(i)}}))}closePreview(){$("#preview-panel").addClass("hidden"),setTimeout((()=>{$("#preview-panel").hide(),$("#main-panel").removeClass("col-md-8").addClass("col-md-12")}),300),this.currentPreviewFile=null}hidePreview(){$("#preview-panel").addClass("hidden"),setTimeout((()=>{$("#preview-panel").hide(),$("#main-panel").removeClass("col-md-8").addClass("col-md-12")}),300),this.currentPreviewFile=null}showPreviewLoading(){$("#preview-loading").show(),$("#preview-body").hide(),$(".preview-filename").text("Loading...")}hidePreviewLoading(){$("#preview-loading").hide(),$("#preview-body").show()}showPreviewError(e){this.hidePreviewLoading(),$("#preview-body").html(`\n            <div class="preview-error text-center py-5">\n                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>\n                <p class="text-muted">${e}</p>\n            </div>\n        `)}renderPreview(e){this.currentPreviewFile=e;const t=this.getFileIcon(e.name,e.mime_type);let s;if(this.isOfficeFile(e)){const t=window.location.origin+"/api/preview/"+this.encodePath(e.path);s="https://docs.google.com/gview?url="+encodeURIComponent(t)+"&embedded=true"}else s="/api/preview/"+this.encodePath(e.path);$(".preview-icon").attr("class",t+" preview-icon"),$(".preview-filename").html(`\n        <button class="btn btn-sm btn-outline-primary me-2" onclick="window.open('${s}', '_blank')">\n            <i class="fas fa-external-link-alt"></i> Open in new tab\n        </button>\n        <button class="btn btn-sm btn-outline-success" onclick="fileManager.showPrintModalFromPreview('${e.path}', '${e.name}')">\n            <i class="fas fa-print"></i> Print\n        </button>\n    `),this.hidePreviewLoading(),console.log("renderPreview - file.is_previewable:",e.is_previewable),console.log("renderPreview - this.isOfficeFile(file):",this.isOfficeFile(e)),e.is_previewable||this.isOfficeFile(e)?(console.log("Calling loadPreviewContent for:",e.name),this.loadPreviewContent(e)):(console.log("Calling showNonPreviewableFile for:",e.name),this.showNonPreviewableFile(e))}loadPreviewContent(e){console.log("loadPreviewContent called with file:",e),console.log("isOfficeFile result:",this.isOfficeFile(e));const t="/api/preview/"+this.encodePath(e.path);this.isOfficeFile(e)?(console.log("Showing Office preview for:",e.name),this.showOfficePreview(e)):e.mime_type&&e.mime_type.startsWith("image/")?this.showImagePreview(t,e):"application/pdf"===e.mime_type?this.showPdfPreview(t,e):this.isTextFile(e)?this.showTextPreview(t,e):(console.log("Showing non-previewable file for:",e.name),this.showNonPreviewableFile(e))}showOfficePreview(e){const t=window.location.origin+"/api/preview/"+this.encodePath(e.path),s="https://docs.google.com/gview?url="+encodeURIComponent(t)+"&embedded=true";$("#preview-body").html(`\n        <div class="office-preview">\n            <iframe src="${s}" class="preview-iframe" frameborder="0"></iframe>\n        </div>\n    `)}showImagePreview(e,t){$("#preview-body").html(`\n            <div class="image-preview">\n                <img src="${e}" alt="${t.name}" class="preview-image" />\n            </div>\n        `)}showPdfPreview(e,t){$("#preview-body").html(`\n            <div class="pdf-preview">\n                <iframe src="${e}" class="preview-iframe" frameborder="0"></iframe>\n            </div>\n        `)}showTextPreview(e,t){$.ajax({url:e,method:"GET",dataType:"text",success:e=>{let t=e;e.length>1e4&&(t=e.substring(0,1e4)+"\n\n... (content truncated, download to see full file)"),$("#preview-body").html(`\n                    <div class="text-preview">\n                        <pre class="preview-code"><code>${this.escapeHtml(t)}</code></pre>\n                    </div>\n                `)},error:()=>{this.showPreviewError("Failed to load text content")}})}showNonPreviewableFile(e){$("#preview-body").html(`\n            <div class="non-previewable text-center py-5">\n                <i class="${this.getFileIcon(e.name,e.mime_type)} fa-4x text-muted mb-3"></i>\n                <h5>${e.name}</h5>\n                <p class="text-muted">This file type cannot be previewed</p>\n            </div>\n        `)}isTextFile(e){return!!e.mime_type&&(e.mime_type.startsWith("text/")||["application/json","application/xml","application/javascript"].includes(e.mime_type)||["txt","md","json","xml","html","htm","css","js","php","py","java","c","cpp","sql"].includes(e.extension))}isOfficeFile(e){console.log("isOfficeFile called with:",e),console.log("file.mime_type:",e.mime_type),console.log("file.name:",e.name),console.log("file.extension:",e.extension);const t=e.extension||(e.name?e.name.toLowerCase().split(".").pop():"");console.log("Extracted extension:",t);const s=["docx","xlsx","pptx","doc","xls","ppt","odt","ods","odp","csv","rtf"].includes(t);let i=!1;if(e.mime_type){i=["application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/msword","application/vnd.ms-excel","application/vnd.ms-powerpoint","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","text/csv","application/rtf"].includes(e.mime_type)}return console.log("MIME type match:",i),console.log("Extension match:",s),i||s}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showNotes(e){const t=$("#notes-section"),s=t.find("#notes-list");t.show(),s.empty(),Array.isArray(e)&&e.length>0?e.forEach((e=>{s.append(this.createNoteElement(e))})):s.html('<p class="text-muted text-center">No notes yet. Click "Add Note" to create one.</p>')}createNoteElement(e){const t=new Date(e.modified||e.created).toLocaleString(),s=e.content.length>100;return $(`\n            <div class="note-item" data-note-id="${e.id}">\n                <div class="d-flex justify-content-between align-items-start">\n                    <div class="note-header">\n                        <div class="note-timestamp">\n                            <i class="fas fa-clock"></i> ${t}\n                        </div>\n                    </div>\n                    <div class="note-actions">\n                        <button class="btn btn-sm btn-outline-primary edit-note">\n                            <i class="fas fa-edit"></i>\n                        </button>\n                        <button class="btn btn-sm btn-outline-danger delete-note">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="note-content ${s?"collapsed":""}">${e.content}</div>\n                ${s?'<button class="read-more-btn" data-state="collapsed">Read More</button>':""}\n                <textarea class="note-editor" style="display: none;">${e.content}</textarea>\n                <div class="edit-actions" style="display: none;">\n                    <button class="btn btn-sm btn-primary save-note">Save</button>\n                    <button class="btn btn-sm btn-secondary cancel-edit">Cancel</button>\n                </div>\n            </div>\n        `)}hideNotes(){$("#notes-section").hide()}enterNoteEditMode(e){e.find(".note-content, .note-actions").hide(),e.find(".note-editor, .edit-actions").show(),e.find(".note-editor").focus()}exitNoteEditMode(e,t=!1){const s=e.data("note-id"),i=e.find(".note-editor").val().trim();if(t){const e="new"===s?"add":"edit";this.saveNote({noteId:s,content:i,action:e})}else e.find(".note-editor, .edit-actions").hide(),e.find(".note-content, .note-actions").show()}saveNote(e){this.currentPath||""===this.currentPath?$.ajax({url:"/api/save-notes",method:"POST",data:{path:this.currentPath,noteId:e.noteId,content:e.content,action:e.action},success:e=>{e.success?(this.showNotes(e.notes),this.showSuccess("Note saved successfully")):this.showError("Failed to save note: "+e.message)},error:(e,t,s)=>{this.showError("Error saving note")}}):this.showError("Current path is not set. Please refresh the page.")}deleteNote(e){confirm("Are you sure you want to delete this note?")&&$.ajax({url:"/api/save-notes",method:"POST",data:{path:this.currentPath,noteId:e,action:"delete"},success:e=>{e.success?(this.showNotes(e.notes),this.showSuccess("Note deleted successfully")):this.showError("Failed to delete note: "+e.message)},error:()=>{this.showError("Error deleting note")}})}toggleReadMore(e){const t=$(e.currentTarget),s=t.siblings(".note-content");"collapsed"===t.attr("data-state")?(s.removeClass("collapsed"),t.attr("data-state","expanded"),t.text("Show Less")):(s.addClass("collapsed"),t.attr("data-state","collapsed"),t.text("Read More"))}handleSearchInput(e){const t=$(e.target).val().trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),t.length<2)return this.hideSearchSuggestions(),void $("#search-clear").hide();$("#search-clear").show(),this.searchTimeout=setTimeout((()=>{this.performSearch(t)}),300)}handleSearchBlur(e){$(e.target);const t=$("#search-suggestions");t.is(e.relatedTarget)||t.has(e.relatedTarget).length||setTimeout((()=>{this.hideSearchSuggestions()}),200)}handleSearchKeydown(e){const t=$("#search-suggestions"),s=t.find(".search-suggestion.active");"ArrowDown"===e.key?(e.preventDefault(),s.length?s.removeClass("active").next().addClass("active"):t.find(".search-suggestion:first").addClass("active")):"ArrowUp"===e.key?(e.preventDefault(),s.length?s.removeClass("active").prev().addClass("active"):t.find(".search-suggestion:last").addClass("active")):"Enter"===e.key?(e.preventDefault(),s.length&&s.click()):"Escape"===e.key&&(this.hideSearchSuggestions(),$("#search-input").blur())}handleSuggestionClick(e){e.preventDefault();const t=$(e.currentTarget).data("item");if("folder"===t.type)this.loadDirectory(t.path),this.hideSearchSuggestions(),$("#search-input").val("");else if("note"===t.type){const e=t.path||"";this.loadDirectory(e),this.hideSearchSuggestions(),$("#search-input").val(""),setTimeout((()=>{this.scrollToNotesSection()}),500)}else{const e=this.dirname(t.path);this.loadDirectory(e),this.hideSearchSuggestions(),$("#search-input").val(""),setTimeout((()=>{$(`.file-item[data-path="${t.path}"]`).click()}),100)}}clearSearch(){$("#search-input").val(""),this.hideSearchSuggestions(),$("#search-clear").hide()}showSearchSuggestions(){$("#search-suggestions").show(),this.searchVisible=!0}hideSearchSuggestions(){$("#search-suggestions").hide(),this.searchVisible=!1}performSearch(e){$.ajax({url:"/api/search/suggestions",method:"GET",data:{q:e},dataType:"json",success:e=>{e.success?this.renderSearchSuggestions(e.suggestions):this.showError("Search error: "+(e.message||"Unknown error"))},error:e=>{this.showError("Search failed: "+e.statusText)}})}renderSearchSuggestions(e){const t=$("#search-suggestions");t.empty(),0!==e.length?(e.forEach((e=>{const s=e.item,i=this.getFileIconClass(s),a=this.getTypeClass(s.type),o=this.getTypeText(s.type),n=$(`\n            <div class="search-suggestion" data-item="${JSON.stringify(s).replace(/"/g,"&quot;")}">\n                <div class="search-suggestion-icon ${s.type}">\n                    <i class="${i}"></i>\n                </div>\n                <div class="search-suggestion-content">\n                    <div class="suggestion-name">${s.name}</div>\n                    ${"note"===s.type?`<div class="suggestion-content">${s.content||s.name}</div>`:""}\n                    <div class="suggestion-path">${e.path_parts.join(" / ")}</div>\n                </div>\n                <div class="suggestion-type">\n                    <span class="badge badge-${a}">${o}</span>\n                </div>\n            </div>\n        `);t.append(n)})),this.showSearchSuggestions()):t.html('<div class="search-suggestion no-results"><i class="fas fa-search"></i> No results found</div>')}getFileIconClass(e){if("note"===e.type)return"fas fa-sticky-note";if("folder"===e.type)return"fas fa-folder";return{pdf:"fas fa-file-pdf file-icon-pdf",doc:"fas fa-file-word file-icon-doc",docx:"fas fa-file-word file-icon-doc",xls:"fas fa-file-excel file-icon-xls",xlsx:"fas fa-file-excel file-icon-xls",ppt:"fas fa-file-powerpoint file-icon-ppt",pptx:"fas fa-file-powerpoint file-icon-ppt",jpg:"fas fa-file-image file-icon-image",jpeg:"fas fa-file-image file-icon-image",png:"fas fa-file-image file-icon-image",gif:"fas fa-file-image file-icon-image",svg:"fas fa-file-image file-icon-image",mp4:"fas fa-file-video file-icon-video",avi:"fas fa-file-video file-icon-video",mov:"fas fa-file-video file-icon-video",mp3:"fas fa-file-audio file-icon-audio",wav:"fas fa-file-audio file-icon-audio",zip:"fas fa-file-archive file-icon-archive",rar:"fas fa-file-archive file-icon-archive","7z":"fas fa-file-archive file-icon-archive",js:"fas fa-file-code file-icon-code",html:"fas fa-file-code file-icon-code",css:"fas fa-file-code file-icon-code",php:"fas fa-file-code file-icon-code",py:"fas fa-file-code file-icon-code",java:"fas fa-file-code file-icon-code",txt:"fas fa-file-alt file-icon-text",md:"fas fa-file-alt file-icon-text"}[this.getFileExtension(e.name).toLowerCase()]||"fas fa-file file-icon-text"}getTypeClass(e){return{note:"info",folder:"primary",file:"secondary"}[e]||"secondary"}getTypeText(e){return{note:"Note",folder:"Folder",file:"File"}[e]||"File"}getFileExtension(e){return e.split(".").pop()||""}scrollToNotesSection(){$("#notes-section").show(),$("html, body").animate({scrollTop:$("#notes-section").offset().top-100},500)}}$(document).ready((function(){try{window.fileManager=new FileManager,window.addEventListener("popstate",(function(e){const t=e.state?.path||"";window.fileManager.currentPath=t,window.fileManager.loadDirectory(t)}))}catch(e){}}));